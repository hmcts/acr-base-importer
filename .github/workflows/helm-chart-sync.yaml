name: Sync Non-OCI Helm Charts to ACR

on:
  schedule:
    - cron: '0 0 * * *'  # Run daily at midnight UTC
  workflow_dispatch:  # Allow manual trigger
  push:
    branches:
      - master
    paths:
      - 'helm-charts.yaml'
      - '.github/workflows/helm-chart-sync.yaml'

jobs:
  sync-helm-charts:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          # Install mikefarah/yq (Go version)
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          
          # Verify it's the correct version
          yq --version
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: 0c90bba4-bee6-42d1-8398-dedede1319d1
          tenant-id: 531ff96d-0ae9-462a-8d2d-bec7c0b42082
          allow-no-subscriptions: true
      
      - name: Get ACR list
        id: acr-list
        run: |
          # Extract unique ACR names from config
          ACR_NAMES=$(yq eval '.charts[].acr_registries[]' helm-charts.yaml | sort -u | tr '\n' ' ')
          echo "acr_names=$ACR_NAMES" >> $GITHUB_OUTPUT
          echo "Found ACR registries: $ACR_NAMES"
      
      - name: ACR Login
        run: |
          # Login to all ACRs
          for ACR in ${{ steps.acr-list.outputs.acr_names }}; do
            echo "Logging into $ACR..."
            az acr login --name $ACR
          done
      
      - name: Sync Helm Charts
        run: |
          # Don't exit on error - we want to try all charts/versions/ACRs
          set +e
          OVERALL_SUCCESS=0
          
          # Read the helm-charts.yaml file
          if [ ! -f helm-charts.yaml ]; then
            echo "Error: helm-charts.yaml not found"
            exit 1
          fi
          
          # Get number of charts
          CHART_COUNT=$(yq eval '.charts | length' helm-charts.yaml)
          echo "Found $CHART_COUNT chart(s) to sync"
          
          # Loop through each chart
          for i in $(seq 0 $((CHART_COUNT - 1))); do
            NAME=$(yq eval ".charts[$i].name" helm-charts.yaml)
            REPO_URL=$(yq eval ".charts[$i].repo_url" helm-charts.yaml)
            REPO_NAME=$(yq eval ".charts[$i].repo_name" helm-charts.yaml)
            CHART_NAME=$(yq eval ".charts[$i].chart_name" helm-charts.yaml)
            ACR_DEST=$(yq eval ".charts[$i].acr_destination" helm-charts.yaml)
            VERSION_PATTERN=$(yq eval ".charts[$i].version_pattern // \"*\"" helm-charts.yaml)
            
            # Get ACR registries for this chart
            ACR_REGISTRY_COUNT=$(yq eval ".charts[$i].acr_registries | length" helm-charts.yaml)
            ACR_REGISTRIES=()
            for j in $(seq 0 $((ACR_REGISTRY_COUNT - 1))); do
              ACR_REGISTRIES+=($(yq eval ".charts[$i].acr_registries[$j]" helm-charts.yaml))
            done
            
            echo ""
            echo "=========================================="
            echo "Processing: $NAME"
            echo "Repo: $REPO_URL"
            echo "Chart: $CHART_NAME"
            echo "ACR Destination: $ACR_DEST"
            echo "Target ACRs: ${ACR_REGISTRIES[@]}"
            echo "=========================================="
            
            # Add helm repo (suppress output)
            helm repo add "$REPO_NAME" "$REPO_URL" > /dev/null 2>&1 || true
            helm repo update "$REPO_NAME" > /dev/null 2>&1
            
            # Get all available versions from upstream
            AVAILABLE_VERSIONS=$(helm search repo "$REPO_NAME/$CHART_NAME" --versions -o json | jq -r '.[].version')
            
            if [ -z "$AVAILABLE_VERSIONS" ]; then
              echo "Warning: No versions found for $CHART_NAME"
              continue
            fi
            
            TOTAL_AVAILABLE=$(echo "$AVAILABLE_VERSIONS" | wc -l | tr -d ' ')
            echo "Found $TOTAL_AVAILABLE version(s) upstream (latest: $(echo "$AVAILABLE_VERSIONS" | head -1))"
            
            # Loop through each ACR registry
            for ACR_NAME in "${ACR_REGISTRIES[@]}"; do
              # Helm appends the chart name to the destination path
              ACR_REPO_PATH="${ACR_DEST}/${CHART_NAME}"
              
              # Get existing versions from ACR
              ACR_VERSIONS=$(az acr repository show-tags --name "$ACR_NAME" --repository "$ACR_REPO_PATH" --output json 2>/dev/null | jq -r '.[]' | sort || echo "")
              
              # Sync each version
              SYNCED_COUNT=0
              SKIPPED_COUNT=0
            
              for VERSION in $AVAILABLE_VERSIONS; do
                # Check if version matches pattern (if specified)
                if [ "$VERSION_PATTERN" != "*" ]; then
                  if ! echo "$VERSION" | grep -qE "^${VERSION_PATTERN}$"; then
                    echo "    Skipping $VERSION (doesn't match pattern: $VERSION_PATTERN)"
                    ((SKIPPED_COUNT++))
                    continue
                  fi
                fi
                
                # Check if version already exists in ACR (more robust comparison)
                VERSION_EXISTS=0
                while IFS= read -r ACR_VERSION; do
                  if [ "$ACR_VERSION" = "$VERSION" ]; then
                    VERSION_EXISTS=1
                    break
                  fi
                done <<< "$ACR_VERSIONS"
                
                if [ $VERSION_EXISTS -eq 1 ]; then
                  ((SKIPPED_COUNT++))
                  continue
                fi
                
                # Only show output for versions we're actually syncing
                if [ $SYNCED_COUNT -eq 0 ]; then
                  echo ""
                  echo "------------------------------------------"
                  echo "Syncing to ACR: $ACR_NAME"
                  echo "------------------------------------------"
                fi
                
                echo "  → Syncing version $VERSION..."
                
                # Create temp directory for this chart
                TEMP_DIR=$(mktemp -d)
                cd "$TEMP_DIR"
                
                # Pull chart from upstream (suppress output)
                if helm pull "$REPO_NAME/$CHART_NAME" --version "$VERSION" > /dev/null 2>&1; then
                  CHART_FILE="${CHART_NAME}-${VERSION}.tgz"
                  
                  # Push to ACR (suppress output)
                  if helm push "$CHART_FILE" "oci://${ACR_NAME}.azurecr.io/$ACR_DEST" > /dev/null 2>&1; then
                    echo "  ✓ Successfully pushed $VERSION to $ACR_NAME"
                    ((SYNCED_COUNT++))
                  else
                    echo "  ✗ Failed to push $VERSION to $ACR_NAME"
                  fi
                else
                  echo "  ✗ Failed to pull $VERSION from upstream"
                fi
                
                # Cleanup
                cd - > /dev/null
                rm -rf "$TEMP_DIR"
              done
              
              # Only show summary if there was activity
              if [ $SYNCED_COUNT -gt 0 ] || [ $SKIPPED_COUNT -eq 0 ]; then
                echo ""
                echo "Summary for $NAME in $ACR_NAME:"
                echo "  - Synced: $SYNCED_COUNT new version(s)"
                if [ $SKIPPED_COUNT -gt 0 ]; then
                  echo "  - Skipped: $SKIPPED_COUNT existing version(s)"
                fi
              fi
              
              # Track if we had any failures
              if [ $SYNCED_COUNT -eq 0 ] && [ $(echo "$AVAILABLE_VERSIONS" | wc -l) -gt $(echo "$ACR_VERSIONS" | wc -l) ]; then
                echo "  ⚠ Warning: Expected to sync versions but none were synced"
                OVERALL_SUCCESS=1
              fi
            done
          done
          
          echo ""
          echo "=========================================="
          echo "Sync complete!"
          echo "=========================================="
          
          # Exit with error if we had issues
          exit $OVERALL_SUCCESS
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "Helm chart sync failed. Check the logs above for details."
          # Add Slack/Teams notification here if needed
