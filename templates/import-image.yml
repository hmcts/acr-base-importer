# Template: Import Image to ACR
# Purpose: Import a container image to Azure Container Registry

parameters:
- name: baseRegistry
  type: string
  displayName: 'Base Registry'
- name: baseImage
  type: string
  displayName: 'Base Image'
- name: baseTag
  type: string
  displayName: 'Base Tag'
- name: targetImage
  type: string
  displayName: 'Target Image'
- name: acrName
  type: string
  displayName: 'ACR Name'
- name: serviceConnection
  type: string
  displayName: 'Service Connection'
- name: baseDigest
  type: string
  displayName: 'Base Image Digest'
- name: acrDigest
  type: string
  default: ''
  displayName: 'Current ACR Image Digest (empty if first time import)'
- name: targetRegistry
  type: string
  displayName: 'Target Registry (ACR registry name, e.g. hmctspublic.azurecr.io)'
- name: taskName
  type: string
  displayName: 'Task Name (must be unique in job)'
- name: condition
  type: string
  default: 'true'
  displayName: 'Task Condition'

steps:
# First import with digest-tagged version
- task: AzureCLI@2
  displayName: 'Import with digest tag: ${{ parameters.baseImage }}:${{ parameters.baseTag }}'
  name: import_digest_${{ parameters.taskName }}
  condition: ${{ parameters.condition }}
  inputs:
    azureSubscription: ${{ parameters.serviceConnection }}
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      echo "Importing ${{ parameters.baseRegistry }}/${{ parameters.baseImage }}:${{ parameters.baseTag }} as ${{ parameters.targetImage }}:${{ parameters.baseTag }}-${{ parameters.baseDigest }} ..."
      az acr import --force --name ${{ parameters.acrName }} --source ${{ parameters.baseRegistry }}/${{ parameters.baseImage }}:${{ parameters.baseTag }} --image ${{ parameters.targetImage }}:${{ parameters.baseTag }}-${{ parameters.baseDigest }}

# Re-tag as latest (only if import task actually ran and succeeded)
- task: AzureCLI@2
  displayName: 'Re-tag as latest: ${{ parameters.baseImage }}:${{ parameters.baseTag }}'
  name: ${{ parameters.taskName }}
  condition: eq(steps.import_digest_${{ parameters.taskName }}.outcome, 'Succeeded')
  inputs:
    azureSubscription: ${{ parameters.serviceConnection }}
    scriptType: bash
    scriptLocation: scriptPath
    scriptPath: $(System.DefaultWorkingDirectory)/scripts/tag-new-image.sh
    arguments: >
      --baseTag "${{ parameters.baseTag }}"
      --targetImage "${{ parameters.targetImage }}"
      --acrName "${{ parameters.acrName }}"
      --targetRegistry "${{ parameters.targetRegistry }}"
      --baseDigest "${{ parameters.baseDigest }}"
      --acrDigest "${{ parameters.acrDigest }}"
