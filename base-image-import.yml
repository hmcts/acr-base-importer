#
## Import new image on base image update
##
name: ACR base image import 
trigger:
  - master
pr: none
schedules:
- cron: '0 1 * * *'
  displayName: Daily build
  branches:
    include:
    - master
  always: 'true'
variables:
  acrName: hmctspublic
  targetRegistry: hmctspublic.azurecr.io
  keyvaultName: 'infra-vault-prod'
  serviceConnection: 'azurerm-prod'
  keyvaultNameStg: 'cftapps-stg'
  serviceConnectionStg: 'DCD-CFTAPPS-STG'
  neuvectorController: 'https://neuvector01.service.core-compute-aat.internal/api'

jobs:
- job: ImportBaseImages
  pool:
    name: hmcts-agent-pool
  strategy:
    maxParallel: 4
    matrix: 
      node-8-alpine:
        baseImage: library/node
        baseRegistry: docker.io
        baseTag: 8-alpine
        baseImageType: docker  # docker or gcr
        targetImage: imported/library/node-alpine-lts-8
      node-10-alpine:
        baseImage: library/node
        baseRegistry: docker.io
        baseTag: 10-alpine
        baseImageType: docker  # docker or gcr
        targetImage: imported/library/node-alpine-lts-10
      node-8-stretch-slim:
        baseImage: library/node
        baseRegistry: docker.io
        baseTag: 8-stretch-slim
        baseImageType: docker  # docker or gcr
        targetImage: imported/library/node-stretch-slim-lts-8
      node-10-stretch-slim:
        baseImage: library/node
        baseRegistry: docker.io
        baseTag: 10-stretch-slim
        baseImageType: docker  # docker or gcr
        targetImage: imported/library/node-stretch-slim-lts-10
      openjdk-8-distroless:
        baseImage: distroless/java
        baseRegistry: gcr.io
        baseTag: 8
        baseImageType: gcr  # docker or gcr
        targetImage: imported/distroless/jav
      openjdk-8-debug-distroless:
        baseImage: distroless/java
        baseRegistry: gcr.io
        baseTag: 8-debug
        baseImageType: gcr  # docker or gcr
        targetImage: imported/distroless/java
      openjdk-11-distroless:
        baseImage: distroless/java
        baseRegistry: gcr.io
        baseTag: 11
        baseImageType: gcr  # docker or gcr
        targetImage: imported/distroless/java
      openjdk-11-debug-distroless:
        baseImage: distroless/java
        baseRegistry: gcr.io
        baseTag: 11-debug
        baseImageType: gcr  # docker or gcr
        targetImage: imported/distroless/java
  steps:
  - task: AzureKeyVault@1
    displayName: 'Get secrets from Keyvault'
    inputs:
      azureSubscription: $(serviceConnection)
      keyVaultName: $(keyvaultName)
      secretsFilter: 'registry-public-username,registry-public-password,registry-slack-webhook'
  
  - task: AzureKeyVault@1
    displayName: 'Get secrets from Keyvault'
    inputs:
      azureSubscription: $(serviceConnectionStg)
      keyVaultName: $(keyvaultNameStg)
      secretsFilter: 'neuvector-admin-username,neuvector-new-admin-password'
  
  - task: AzureCLI@1
    displayName: 'Check base registry if new digest available for tag'
    inputs:
      azureSubscription: $(serviceConnection)
      scriptLocation: 'scriptPath'
      scriptPath: check-base-tag.sh
      arguments: |
        "$(baseImage)" "$(baseRegistry)" "$(baseTag)" "$(targetImage)" "$(baseImageType)" "$(acrName)"

  - task: AzureCLI@1
    displayName: 'Import gcr image' # acr import does not work with gcr (see: https://github.com/Azure/azure-cli/issues/9557)
    condition: and(eq(variables['newTagFound'], 'true'), eq(variables['baseImageType'], 'gcr'))
    inputs:
      azureSubscription: $(serviceConnection)
      scriptLocation: 'scriptPath'
      scriptPath: import-gcr-image.sh
      arguments: |
        "$(baseImage)" "$(baseRegistry)" "$(baseTag)" "$(targetImage)" "$(acrName)" "$(targetRegistry)" "$(baseDigest)"

  - task: AzureCLI@1
    displayName: 'Import docker image'
    condition: and(eq(variables['newTagFound'], 'true'), eq(variables['baseImageType'], 'docker'))
    inputs:
      azureSubscription: $(serviceConnection)
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "Importing $(baseRegistry)/$(baseImage):$(baseTag) ..."
        az acr import --force --name $(acrName) --source $(baseRegistry)/$(baseImage):$(baseTag) --image $(targetImage):$(baseTag)-$(baseDigest) 

  - task: AzureCLI@1
    displayName: 'Security scan new image'
    condition: eq(variables['newTagFound'], 'true')
    inputs:
      azureSubscription: $(serviceConnection)
      scriptLocation: 'scriptPath'
      scriptPath: base-image-scan.sh
      arguments: |
        "$(targetRegistry)" "$(targetImage)" "$(baseTag)-$(baseDigest)" "$(registry-public-username)" "$(registry-public-password)" 
        "$(registry-slack-webhook)" "$(neuvectorController)" "$(neuvector-admin-username)" "$(neuvector-new-admin-password)"

  - task: AzureCLI@1
    displayName: 'Re-tag new image using the base tag'
    condition: and(eq(variables['newTagFound'], 'true'), eq(variables['scanPassed'], 'true'))
    inputs:
      azureSubscription: $(serviceConnection)
      scriptLocation: 'scriptPath'
      scriptPath: tag-new-image.sh
      arguments: |
        "$(baseTag)" "$(targetImage)" "$(acrName)" "$(targetRegistry)" "$(baseDigest)" "$(acrDigest)" 

- job: NotifyFailure
  pool:
    name: hmcts-agent-pool
  dependsOn: ImportBaseImages
  condition: failed() # this job will only run if import fails
  steps:
  - task: AzureKeyVault@1
    displayName: 'Get secrets from Keyvault'
    inputs:
      azureSubscription: $(serviceConnection)
      keyVaultName: $(keyvaultName)
      secretsFilter: 'registry-slack-webhook'
  
  - task: AzureCLI@1
    displayName: 'Notify error'
    inputs:
      azureSubscription: $(serviceConnection)
      scriptLocation: 'scriptPath'
      scriptPath: slack-notify.sh
      arguments: |
        "Error running base images import task." "$(registry-slack-webhook)" "liam_is_watching"

- job: NotifySuccess
  pool:
    name: hmcts-agent-pool
  dependsOn: ImportBaseImages
  condition: succeeded() # this job will only run if import succeeds
  steps:
  - task: AzureKeyVault@1
    displayName: 'Get secrets from Keyvault'
    inputs:
      azureSubscription: $(serviceConnection)
      keyVaultName: $(keyvaultName)
      secretsFilter: 'registry-slack-webhook'
  
  - task: AzureCLI@1
    displayName: 'Notify success'
    inputs:
      azureSubscription: $(serviceConnection)
      scriptLocation: 'scriptPath'
      scriptPath: slack-notify.sh
      arguments: |
        "Completed base images import task." "$(registry-slack-webhook)" "tim-webster"
